#!/bin/bash
# Block direct pushes to main branch on UPSTREAM (idvorkin) only
# Origin (idvorkin-ai-tools) is the agent working repo - pushes allowed
#
# This hook receives: $1 = remote name, $2 = remote URL

remote_name="$1"
remote_url="$2"

protected_branch="main"

# Check if pushing to upstream (idvorkin repo) vs origin (idvorkin-ai-tools)
is_upstream=false
if [[ "$remote_url" == *"idvorkin/swing-analyzer"* ]] || [[ "$remote_name" == "upstream" ]]; then
    is_upstream=true
fi

while read local_ref local_sha remote_ref remote_sha; do
    if [[ "$remote_ref" == "refs/heads/$protected_branch" ]]; then
        if $is_upstream; then
            echo ""
            echo "ðŸš« Direct push to '$protected_branch' on UPSTREAM is blocked!"
            echo ""
            echo "   The upstream repo (idvorkin) requires PRs for all changes."
            echo ""
            echo "   Instead:"
            echo "   1. Push to origin: git push origin main"
            echo "   2. Create PR to upstream: gh pr create --repo idvorkin/swing-analyzer"
            echo ""
            echo "   To bypass (emergencies only): git push --no-verify"
            echo ""
            exit 1
        else
            # Pushing to origin (idvorkin-ai-tools) - this is allowed
            echo "âœ… Pushing to origin/main (agent working repo)"
        fi
    fi
done

exit 0
